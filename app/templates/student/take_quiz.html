{% extends "base.html" %}

{% block content %}
<div id="quiz-container">
    <h2 id="quiz-title">{{ quiz.title }}</h2>
    <div id="quiz-area">
        <!-- Questions will be injected here by JavaScript -->
    </div>
    <div id="result-area" style="display: none;">
        <h3>Mission Complete!</h3>
        <p>Your Score: <span id="score"></span> / <span id="total"></span></p>
        <p>XP Earned: +<span id="xp_earned"></span></p>
        <a href="{{ url_for('main.student_dashboard') }}" class="btn btn-primary">Back to Dashboard</a>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // The 'safe' filter tells Jinja that the string is safe to render as-is,
    // preventing it from escaping characters. We then parse this clean JSON string.
    console.log('Raw quiz JSON:', '{{ quiz_json|safe }}');
    const quizData = JSON.parse('{{ quiz_json|safe }}');
    console.log('Parsed quiz data:', quizData);

    const quizArea = document.getElementById('quiz-area');
    const resultArea = document.getElementById('result-area');
    let currentQuestionIndex = 0;
    const userAnswers = {};

    function displayQuestion() {
        console.log('Displaying question, current index:', currentQuestionIndex);
        console.log('Total questions:', quizData.questions.length);
        
        if (currentQuestionIndex >= quizData.questions.length) {
            console.log('No more questions, submitting quiz');
            submitQuiz();
            return;
        }
        
        const question = quizData.questions[currentQuestionIndex];
        console.log('Current question:', question);
        
        let optionsHtml = '';
        question.options.forEach(option => {
            optionsHtml += `
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="question-${question.id}" id="option-${option.id}" value="${option.id}">
                    <label class="form-check-label" for="option-${option.id}">${option.text}</label>
                </div>`;
        });

        quizArea.innerHTML = `
            <div class="card my-3">
                <div class="card-body">
                    <h5 class="card-title">${question.text}</h5>
                    <form>${optionsHtml}</form>
                    <button class="btn btn-primary mt-3" onclick="nextQuestion()">Next</button>
                </div>
            </div>`;
    }

    function nextQuestion() {
        const question = quizData.questions[currentQuestionIndex];
        const selectedOption = document.querySelector(`input[name="question-${question.id}"]:checked`);
        if (selectedOption) {
            userAnswers[question.id] = selectedOption.value;
            currentQuestionIndex++;
            displayQuestion();
        } else {
            alert('Please select an answer before proceeding.');
        }
    }

    async function submitQuiz() {
        const response = await fetch(`/submit_mission/${quizData.id}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ answers: userAnswers })
        });
        const result = await response.json();
        
        quizArea.style.display = 'none';
        document.getElementById('quiz-title').style.display = 'none';
        resultArea.style.display = 'block';

        document.getElementById('score').innerText = result.score;
        document.getElementById('total').innerText = result.total;
        document.getElementById('xp_earned').innerText = result.xp_earned;
    }

    // Initial load
    if (quizData.questions && quizData.questions.length > 0) {
        displayQuestion();
    } else {
        quizArea.innerHTML = `
            <div class="alert alert-warning">
                <h4>No Questions Available</h4>
                <p>This quiz doesn't have any questions yet. Please contact an administrator.</p>
                <a href="{{ url_for('main.missions') }}" class="btn btn-primary">Back to Missions</a>
            </div>`;
    }
</script>
{% endblock %}
